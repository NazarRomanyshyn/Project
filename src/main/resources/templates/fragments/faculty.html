<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org"
	  xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity3">

<main th:fragment="commonFaculty(title, path, isEditForm)">
	<h3>[[${title}]]</h3>
	<div th:if="${facultyExistsMessage}" class="alert alert-danger" role="alert">
		[[#{facultyExistsMessage}]]
	</div>
	<div id="facultyTotalCoeffMessage" role="alert"></div>
	<form th:object="${faculty}" th:action="${path}" method="post">
		<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
		<input th:if="${!isEditForm}" type="hidden" name="refererURI" th:value="${refererURI}"/>
		<input th:if="${!isEditForm}" type="hidden" name="superRefererURI" th:value="${superRefererURI}"/>
		<div class="form-group row">
			<label class="col-sm-2 col-form-label">[[#{faculty.title}]]: </label>
			<div class="col-sm-6">
				<input class="form-control" type="text" name="title" th:value="${faculty}?*{title}" th:placeholder="#{faculty.title}"/>
				<div id="titleError"></div>
			</div>
		</div>
		<div class="form-check mt-3"><b>[[#{faculty.subjects}]]:</b>
			<div class="form-group row" th:each="subject: ${subjects}">
				<div class="col-sm-2 mt-2">
					<label class="form-check-label">
						<input class="form-check-input" type="checkbox" th:name="${subject.id}" th:value="${subject.title}"
							th:checked="${isEditForm}?${faculty.examSubjects.contains(subject)}"/>
						[[${subject.title}]]
					</label>
				</div>				
				<div class="col-sm-6 pl-0 pr-4">
					<input class="form-control" type="number" step="0.01" min="0" max="1" th:name="|coeff${subject.id}|"
						th:value="${isEditForm}?*{subjectCoeffs[__${subject.id}__]}" th:placeholder="#{faculty.coefficient}"/>
					<div th:id="|coeff${subject.id}Error|"></div>					
				</div>
			</div>
				<label class="form-check-label"><a th:href="@{/subject/create?superRefererURI=__${refererURI}__}">[[#{subject.new}]]...</a></label>
		</div>			
		<button class="btn btn-primary mt-3" type="submit">[[${isEditForm}?#{faculty.save}:#{faculty.create}]]</button>
	</form>
	<script src="../messageResource.js"></script>
	<script>
	messageResource.init({ filePath: '../' });
	var currentLocale = localStorage.getItem('locales');
	messageResource.load('message', function() {}, currentLocale);
	
	document.addEventListener('DOMContentLoaded', function() {
		var checkbox = $("input[type='checkbox']");
		
		for (var i = 0; i < checkbox.length; i++) {
			if (!checkbox[i].checked) {
				$("input[name='coeff" + checkbox[i].name + "']")[0].style.display = 'none';
			}
		}
	});
	
	document.addEventListener('DOMContentLoaded', function() {
		$("input[type='checkbox']").click(function() {
			var state = ($(this)[0].checked) ? 'block' : 'none';
			var field = 'coeff' + $(this).attr('name');
			
			$("input[name='" + field + "']")[0].style.display = state;
			$("input[name='" + field + "']").val('');
			$("div[id='" + field + "Error']").html('');
			$("div[id='" + field + "Error']").removeClass('invalid-feedback');
			$("input[name='" + field + "']").removeClass('is-invalid');
		});
	});
	
	document.addEventListener('DOMContentLoaded', function() {
		$("button[type='submit']").click(function() {
			var checkbox = $("input[type='checkbox']");
			var errors = 0;
			
			errors += validateOnEmptiness('title', 'facultyTitleError');
			
			for (var i = 0; i < checkbox.length; i++) {
				if (checkbox[i].checked) {
					errors += validateOnEmptiness('coeff' + checkbox[i].name, 'facultyCoefficientError');
				}
			}
			
			var checkedSubjects = 0;
			var totalCoeff = 0;
			if (errors == 0) {
				for (var i = 0; i < checkbox.length; i++) {
					if (checkbox[i].checked) {
						checkedSubjects += 1;
						totalCoeff += parseFloat($("input[name='coeff" + checkbox[i].name + "']").val());
					}
				}				
			}
			
			if (errors != 0) {
				$('#facultyTotalCoeffMessage').html('');
				$('#facultyTotalCoeffMessage').removeClass('alert alert-danger');
				return false;
			} else if (checkedSubjects > 0 && totalCoeff != 1) {
 				$('#facultyTotalCoeffMessage').addClass('alert alert-danger');
				$('#facultyTotalCoeffMessage').html(messageResource.get('facultyTotalCoeffMessage', 'message', currentLocale));
				return false;
			} else {
				$('#facultyTotalCoeffMessage').html('');
				$('#facultyTotalCoeffMessage').removeClass('alert alert-danger');
				$('form').submit();
			}
		});
	});
	
	function validateOnEmptiness(field, errorMessage) {
		var errors = 0;
		
		if ($("input[name='" + field + "']").val() == '') {
			$("input[name='" + field + "']").addClass('is-invalid');
			$("div[id='" + field + "Error']").addClass('invalid-feedback');
			$("div[id='" + field + "Error']").html(messageResource.get(errorMessage, 'message', currentLocale));
			errors += 1;
		} else {
			$("div[id='" + field + "Error']").html('');				
			$("div[id='" + field + "Error']").removeClass('invalid-feedback');
			$("input[name='" + field + "']").removeClass('is-invalid');
		}
		return errors;
	}
	</script>
</main>

</html>